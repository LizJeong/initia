name: Build and Upload to GCS

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: '1.22.4'

      - name: Build for Linux
        run: |
          make build-linux-with-shared-library
          cd ./build
          mv libmovevm.so libmovevm.amd64.so
          mv libcompiler.so libcompiler.amd64.so
          tar -czvf initia_${GITHUB_REF#refs/tags/}_Linux_amd64.tar.gz ./initiad libmovevm.amd64.so libcompiler.amd64.so

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Upload to GCS
        env:
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
        run: |
          gsutil cp ./build/initia_${GITHUB_REF#refs/tags/}_Linux_amd64.tar.gz gs://${GCS_BUCKET}/initia/
          # 파일을 공개적으로 접근 가능하게 설정
          gsutil acl ch -u AllUsers:R gs://${GCS_BUCKET}/initia/initia_${GITHUB_REF#refs/tags/}_Linux_amd64.tar.gz

      - name: Generate public URL
        env:
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
        run: |
          echo "Public URL: https://storage.googleapis.com/${GCS_BUCKET}/initia/initia_${GITHUB_REF#refs/tags/}_Linux_amd64.tar.gz" >> $GITHUB_STEP_SUMMARY
